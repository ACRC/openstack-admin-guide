
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Full Shutdown Procedure &#8212; OpenStack Administration Guide  documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Customising the OpenStack Deployment" href="customising_deployment.html" />
    <link rel="prev" title="Operations and Monitoring" href="operations_and_monitoring.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="full-shutdown-procedure">
<h1>Full Shutdown Procedure<a class="headerlink" href="#full-shutdown-procedure" title="Permalink to this headline">¶</a></h1>
<p>In case a full shutdown of the system is required, we advise to use the
following order:</p>
<ul class="simple">
<li><p>Perform a graceful shutdown of all virtual machine instances</p></li>
<li><p>Stop Ceph (if applicable)</p></li>
<li><p>Put all nodes into maintenance mode in Bifrost</p></li>
<li><p>Shut down compute nodes</p></li>
<li><p>Shut down monitoring node</p></li>
<li><p>Shut down network nodes (if separate from controllers)</p></li>
<li><p>Shut down controllers</p></li>
<li><p>Shut down Ceph nodes (if applicable)</p></li>
<li><p>Shut down seed VM</p></li>
<li><p>Shut down Ansible control host</p></li>
</ul>
<div class="section" id="virtual-machines-shutdown">
<h2>Virtual Machines shutdown<a class="headerlink" href="#virtual-machines-shutdown" title="Permalink to this headline">¶</a></h2>
<p>Contact Openstack users to stop their virtual machines gracefully,
If that is not possible shut down VMs using openstack CLI as admin user:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>openstack server list --all-projects -c ID -f value<span class="sb">`</span> <span class="p">;</span> <span class="se">\</span>
<span class="k">do</span> openstack server stop <span class="nv">$i</span> <span class="p">;</span> <span class="k">done</span>
</pre></div>
</div>
</div>
<div class="section" id="set-bifrost-maintenance-mode">
<h2>Set Bifrost maintenance mode<a class="headerlink" href="#set-bifrost-maintenance-mode" title="Permalink to this headline">¶</a></h2>
<p>Set maintenance mode in bifrost to prevent nodes from automatically
powering back on</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bifrost# <span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>openstack --os-cloud bifrost baremetal node list -c UUID -f value<span class="sb">`</span> <span class="p">;</span> <span class="se">\</span>
<span class="k">do</span> openstack --os-cloud bifrost baremetal node maintenance <span class="nb">set</span> --reason full-shutdown <span class="nv">$i</span> <span class="p">;</span> <span class="k">done</span>
</pre></div>
</div>
</div>
<div class="section" id="shut-down-nodes">
<h2>Shut down nodes<a class="headerlink" href="#shut-down-nodes" title="Permalink to this headline">¶</a></h2>
<p>Shut down nodes one at a time gracefully using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl poweroff
</pre></div>
</div>
</div>
<div class="section" id="shut-down-the-seed-vm">
<h2>Shut down the seed VM<a class="headerlink" href="#shut-down-the-seed-vm" title="Permalink to this headline">¶</a></h2>
<p>Shut down seed vm on ansible control host gracefully using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh stack@acme-seed sudo systemctl poweroff
virsh shutdown acme-seed
</pre></div>
</div>
</div>
<div class="section" id="full-power-on-procedure">
<span id="full-power-on"></span><h2>Full Power on Procedure<a class="headerlink" href="#full-power-on-procedure" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Start ansible control host and seed vm</p></li>
<li><p>Remove nodes from maintenance mode in bifrost</p></li>
<li><p>Recover MariaDB cluster</p></li>
<li><p>Start Ceph (if applicable)</p></li>
<li><p>Check that all docker containers are running</p></li>
<li><p>Check Kibana for any messages with log level ERROR or equivalent</p></li>
</ul>
</div>
<div class="section" id="start-ansible-control-host">
<h2>Start Ansible Control Host<a class="headerlink" href="#start-ansible-control-host" title="Permalink to this headline">¶</a></h2>
<p>The Ansible control host is not enrolled in Bifrost and will have to be powered
on manually.</p>
</div>
<div class="section" id="start-seed-vm">
<h2>Start Seed VM<a class="headerlink" href="#start-seed-vm" title="Permalink to this headline">¶</a></h2>
<p>The seed VM (and any other service VM) should start automatically when the seed
hypervisor is powered on. If it does not, it can be started with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>virsh start seed-0
</pre></div>
</div>
</div>
<div class="section" id="unset-bifrost-maintenance-mode">
<h2>Unset Bifrost maintenance mode<a class="headerlink" href="#unset-bifrost-maintenance-mode" title="Permalink to this headline">¶</a></h2>
<p>Unsetting maintenance mode in bifrost should automatically power on the nodes</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bifrost# <span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>openstack --os-cloud bifrost baremetal node list -c UUID -f value<span class="sb">`</span> <span class="p">;</span> <span class="se">\</span>
<span class="k">do</span> openstack --os-cloud bifrost baremetal node maintenance <span class="nb">unset</span> <span class="nv">$i</span> <span class="p">;</span> <span class="k">done</span>
</pre></div>
</div>
</div>
<div class="section" id="recover-mariadb-cluster">
<h2>Recover MariaDB cluster<a class="headerlink" href="#recover-mariadb-cluster" title="Permalink to this headline">¶</a></h2>
<p>If all of the servers were shut down at the same time, it is necessary to run a
script to recover the database once they have all started up. This can be done
with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kayobe# kayobe overcloud database recover
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">OpenStack Administration Guide</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_openstack.html">Working with OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_kayobe.html">Working with Kayobe</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware_inventory_management.html">Hardware Inventory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="ceph_storage.html">Ceph Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="managing_users_and_projects.html">Managing Users and Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="operations_and_monitoring.html">Operations and Monitoring</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Full Shutdown Procedure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#virtual-machines-shutdown">Virtual Machines shutdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="#set-bifrost-maintenance-mode">Set Bifrost maintenance mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shut-down-nodes">Shut down nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shut-down-the-seed-vm">Shut down the seed VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#full-power-on-procedure">Full Power on Procedure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#start-ansible-control-host">Start Ansible Control Host</a></li>
<li class="toctree-l2"><a class="reference internal" href="#start-seed-vm">Start Seed VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unset-bifrost-maintenance-mode">Unset Bifrost maintenance mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#recover-mariadb-cluster">Recover MariaDB cluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="customising_deployment.html">Customising the OpenStack Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpus_in_openstack.html">Support for GPUs in OpenStack</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="operations_and_monitoring.html" title="previous chapter">Operations and Monitoring</a></li>
      <li>Next: <a href="customising_deployment.html" title="next chapter">Customising the OpenStack Deployment</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, StackHPC Ltd.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/full_shutdown.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>